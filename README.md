# å‘ä¸ªä¸œè¥¿

ä¸€ä¸ªå±€åŸŸç½‘æ–‡å­—/æ–‡ä»¶ P2P ä¼ è¾“å·¥å…·ï¼Œç°å·²é›†æˆ TURN æœåŠ¡æ”¯æŒ

> é¡¹ç›®ä¸­ä»…åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å’Œ WebRTC ä¿¡ä»¤è¿«ä¸å¾—å·²éœ€è¦ä¸€ä¸ªè½»é‡åŒ–çš„æœåŠ¡ï¼Œå…¶ä»–æ•°æ®ä¼ è¾“éƒ½é‡‡ç”¨äº†åŸºäº WebRTC çš„ç‚¹å¯¹ç‚¹ä¼ è¾“ï¼Œä¸ç»è¿‡ä¸­é—´æœåŠ¡å™¨ï¼Œæ‰€ä»¥å±€åŸŸç½‘å†…äº’ä¼ ä¸€äº›æ–‡å­—/æ–‡ä»¶éƒ½æ¯”è¾ƒå¿«ã€‚å†…ç½® TURN æœåŠ¡å¯è§£å†³ NAT ç©¿è¶Šé—®é¢˜ã€‚

demo æ¼”ç¤ºï¼šhttps://fagedongxi.com

## æ–°å¢åŠŸèƒ½

- âœ… é›†æˆ Node-TURN æœåŠ¡å™¨ï¼Œè§£å†³ NAT ç©¿è¶Šé—®é¢˜
- âœ… å¯é…ç½®çš„ TURN æœåŠ¡å‚æ•°
- âœ… è‡ªåŠ¨æ£€æµ‹å’Œä½¿ç”¨æœ¬åœ° TURN æœåŠ¡å™¨

## ä¼˜ç‚¹

æ— éœ€å®‰è£…ä»»ä½•è½¯ä»¶ï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œæ— éœ€ç™»å½•ç›´æ¥ä¼ è¾“ã€‚
ç°åœ¨æ”¯æŒè·¨ç½‘ç»œç¯å¢ƒä¼ è¾“ï¼ˆé€šè¿‡å†…ç½® TURN æœåŠ¡å™¨ï¼‰ã€‚

## ç¼ºç‚¹

æ¥æ”¶å¤§æ–‡ä»¶æ¯”è¾ƒåƒå†…å­˜ï¼ˆå•æ–‡ä»¶å‡ ç™¾å…†ä¸€èˆ¬æ²¡é—®é¢˜ï¼‰

## åœºæ™¯ï¼š

æ¯”å¦‚æ–°è£…çš„ win ç³»ç»Ÿéœ€è¦ä» mac ç³»ç»Ÿä¼ ä¸€äº›éœ€è¦ ğŸªœ æ‰èƒ½ä¸‹è½½çš„è½¯ä»¶æˆ–è€…æœåˆ°çš„ä¸€äº›ä¸œè¥¿

## éƒ¨ç½²/å¯åŠ¨

> è‡ª`1.1.0`ç‰ˆæœ¬åï¼Œä¸å†éœ€è¦å•ç‹¬éƒ¨ç½²ç½‘é¡µç«¯äº†ï¼Œä»…å¯åŠ¨ä¸€ä¸ªæœåŠ¡ç«¯å³å¯
> è‡ª`1.1.4`ç‰ˆæœ¬åï¼Œé›†æˆäº† TURN æœåŠ¡å™¨ï¼Œå¯ä»¥è§£å†³ç½‘ç»œè¿é€šæ€§é—®é¢˜

å‚è€ƒè§†é¢‘ï¼šhttps://v.douyin.com/zp_dXkV1fys/

### æºç æ–¹å¼

1. å®‰è£… nodejsï¼Œnode ç‰ˆæœ¬æ²¡æœ‰æµ‹è¯•ï¼Œæˆ‘ç”¨çš„æ˜¯ `16.20.2`
2. ä¸‹è½½æºç 
3. è¿›å…¥ é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿è¡Œ `npm install`
4. åˆ›å»ºé…ç½®æ–‡ä»¶ `config.json`ï¼ˆå¯é€‰ï¼Œå‚è€ƒ `config.example.json`ï¼‰
5. è¿è¡Œ `npm run start`

### äºŒè¿›åˆ¶æ–¹å¼

- ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç›´æ¥æ‰§è¡Œå³å¯
- åˆ›å»ºé…ç½®æ–‡ä»¶ `config.json`ï¼ˆå¯é€‰ï¼Œå‚è€ƒ `config.example.json`ï¼‰
- å¦‚æœä½ ç”¨ windowsï¼Œå¯å‚è€ƒ https://v.douyin.com/CeiJahpLD/ æ³¨å†ŒæˆæœåŠ¡

## é…ç½®æ–‡ä»¶

ç°åœ¨ä½¿ç”¨**ç»Ÿä¸€é…ç½®æ–‡ä»¶** `config.json` æ¥ç®¡ç†æ‰€æœ‰è®¾ç½®ï¼ŒåŒ…å«ä¸‰ä¸ªä¸»è¦æ¿å—ï¼š

### é…ç½®æ–‡ä»¶ç»“æ„

```json
{
  "server": {
    "httpPort": 8081,
    "host": "0.0.0.0"
  },
  "rooms": [
    {
      "roomId": "testroom",
      "pwd": "5d41402abc4b2a76b9719d911017c592",
      "remark": "æµ‹è¯•æˆ¿é—´ - å¯†ç : hello"
    }
  ],
  "turnConfig": {
    "enabled": true,
    "turnPort": 3478,
    "minPort": 49152,
    "maxPort": 65535,
    "debugLevel": "ERROR",
    "listeningIps": ["0.0.0.0"],
    "relayIps": ["0.0.0.0"],
    "authMech": "long-term"
  }
}
```

### é…ç½®æ¿å—è¯´æ˜

#### 1. server æ¿å—

- `httpPort`: Web æœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤ 8081ï¼‰
- `host`: Web æœåŠ¡å™¨ç»‘å®šåœ°å€ï¼ˆé»˜è®¤ 0.0.0.0ï¼‰

#### 2. rooms æ¿å—

- `roomId`: æˆ¿é—´ ID
- `pwd`: æˆ¿é—´å¯†ç çš„ MD5 å“ˆå¸Œå€¼
- `remark`: æˆ¿é—´å¤‡æ³¨è¯´æ˜

#### 3. turnConfig æ¿å—

- `enabled`: æ˜¯å¦å¯ç”¨ TURN æœåŠ¡å™¨ï¼ˆtrue/falseï¼‰
- `turnPort`: TURN æœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤ 3478ï¼‰
- `minPort`/`maxPort`: ä¸­ç»§ç«¯å£èŒƒå›´
- `debugLevel`: æ—¥å¿—çº§åˆ«
- `listeningIps`/`relayIps`: ç›‘å¬å’Œä¸­ç»§ IP åœ°å€

### è¿ç§»è¯´æ˜

é¡¹ç›®ç°å·²å®Œå…¨è¿ç§»åˆ°ç»Ÿä¸€é…ç½®æ–‡ä»¶ `config.json`ã€‚æ—§çš„é…ç½®æ–‡ä»¶ä¸å†æ”¯æŒï¼š

- ~~`turn-config.json`~~ - å·²åˆå¹¶åˆ° `config.json` çš„ `turnConfig` æ¿å—
- ~~`room_pwd.json`~~ - å·²åˆå¹¶åˆ° `config.json` çš„ `rooms` æ¿å—

## TURN æœåŠ¡é…ç½®

åº”ç”¨ä¼šè‡ªåŠ¨ä½¿ç”¨å†…ç½®çš„ TURN æœåŠ¡å™¨ï¼Œæ¯æ¬¡å¯åŠ¨æ—¶**è‡ªåŠ¨ç”Ÿæˆéšæœºçš„ç”¨æˆ·åå’Œå¯†ç **ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®è®¤è¯ä¿¡æ¯ã€‚

### å®‰å…¨ç‰¹æ€§

- âœ… æ¯æ¬¡å¯åŠ¨è‡ªåŠ¨ç”Ÿæˆéšæœºç”¨æˆ·åï¼ˆ10 ä½å­—ç¬¦ï¼‰
- âœ… æ¯æ¬¡å¯åŠ¨è‡ªåŠ¨ç”Ÿæˆéšæœºå¯†ç ï¼ˆ12 ä½å­—ç¬¦ï¼‰
- âœ… ä½¿ç”¨å­—æ¯æ•°å­—æ··åˆï¼ˆa-z, A-Z, 0-9ï¼‰
- âœ… å‰ç«¯è‡ªåŠ¨è·å–æœ€æ–°çš„ TURN è®¤è¯ä¿¡æ¯

### é»˜è®¤ TURN é…ç½®

```json
{
  "enabled": true,
  "turnPort": 3478,
  "minPort": 49152,
  "maxPort": 65535,
  "debugLevel": "ERROR",
  "listeningIps": ["0.0.0.0"],
  "relayIps": ["0.0.0.0"],
  "authMech": "long-term"
}
```

### è‡ªå®šä¹‰ TURN é…ç½®

åœ¨åº”ç”¨ç›®å½•ä¸‹åˆ›å»º `turn-config.json` æ–‡ä»¶æ¥è¦†ç›–é»˜è®¤é…ç½®ï¼ˆè®¤è¯ä¿¡æ¯ä»ç„¶ä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰ï¼š

```json
{
  "enabled": false,
  "turnPort": 3478,
  "minPort": 50000,
  "maxPort": 60000,
  "debugLevel": "WARN"
}
```

#### é…ç½®é€‰é¡¹è¯´æ˜

- `enabled`: å¸ƒå°”å€¼ï¼Œæ§åˆ¶æ˜¯å¦å¯ç”¨ TURN æœåŠ¡å™¨ï¼ˆtrue=å¯ç”¨ï¼Œfalse=ç¦ç”¨ï¼‰
- `turnPort`: TURN æœåŠ¡å™¨ç›‘å¬ç«¯å£
- `minPort`/`maxPort`: ä¸­ç»§ç«¯å£èŒƒå›´
- `debugLevel`: æ—¥å¿—çº§åˆ«ï¼ˆERRORã€WARNã€INFOã€DEBUGï¼‰
- `listeningIps`/`relayIps`: ç›‘å¬å’Œä¸­ç»§ IP åœ°å€

#### TURN æœåŠ¡å¼€å…³

### ä½¿ç”¨ç¤ºä¾‹

#### 1. åˆ›å»ºåŸºæœ¬é…ç½®

```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶
cp config.example.json config.json

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano config.json
```

#### 2. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
npm start

# æˆ–æŒ‡å®šç«¯å£è¦†ç›–é…ç½®
npm start 8082 3479
```

## å®‰å…¨ç‰¹æ€§

- âœ… æ¯æ¬¡å¯åŠ¨è‡ªåŠ¨ç”Ÿæˆéšæœº TURN ç”¨æˆ·åï¼ˆ10 ä½å­—ç¬¦ï¼‰
- âœ… æ¯æ¬¡å¯åŠ¨è‡ªåŠ¨ç”Ÿæˆéšæœº TURN å¯†ç ï¼ˆ12 ä½å­—ç¬¦ï¼‰
- âœ… ä½¿ç”¨å­—æ¯æ•°å­—æ··åˆï¼ˆa-z, A-Z, 0-9ï¼‰
- âœ… å‰ç«¯è‡ªåŠ¨è·å–æœ€æ–°çš„ TURN è®¤è¯ä¿¡æ¯
- âœ… ç»Ÿä¸€é…ç½®ç®¡ç†ï¼Œé¿å…é…ç½®æ–‡ä»¶åˆ†æ•£

## é˜²ç«å¢™é…ç½®

å¦‚æœå¯ç”¨äº† TURN æœåŠ¡å™¨ï¼Œéœ€è¦ç¡®ä¿ä»¥ä¸‹ç«¯å£å¯è®¿é—®ï¼š

- HTTP æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 8081 æˆ–é…ç½®æ–‡ä»¶ä¸­çš„ httpPortï¼‰
- TURN æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 3478 æˆ–é…ç½®æ–‡ä»¶ä¸­çš„ turnPortï¼‰
- TURN ä¸­ç»§ç«¯å£èŒƒå›´ï¼ˆé»˜è®¤ 49152-65535 æˆ–é…ç½®æ–‡ä»¶ä¸­çš„èŒƒå›´ï¼‰

## å¸¸è§é—®é¢˜

åœ¨çº¿åˆ—è¡¨çœ‹è§å¯¹æ–¹ï¼Œä½†ä¸€ç›´å¤„äºæ–­å¼€çš„çŠ¶æ€ä¸”æ— æ³•å‘é€æ¶ˆæ¯ï¼š

- **åŸå› ä¸€**ï¼šæµè§ˆå™¨ä¸æ”¯æŒ WebRTCï¼ˆç›®å‰æœ€æ–°ç‰ˆå·²ç»åœ¨ç”¨æˆ·æ‰“å¼€åè‡ªåŠ¨æ£€æµ‹å¹¶åŠ å…¥æç¤ºï¼‰ï¼Œæ—§ç‰ˆæ²¡æœ‰æ£€æµ‹åŠŸèƒ½å¯ä»¥ä¸´æ—¶ç”¨è¿™ä¸ªè¿›è¡Œæµ‹è¯•ï¼šhttps://space.coze.cn/s/qDNpw1y7MJw/
- **åŸå› äºŒ**ï¼šç½‘ç»œç¯å¢ƒä¸æ”¯æŒäº’ç›¸è®¿é—®
  > **è§£å†³æ–¹æ¡ˆ**ï¼š
  >
  > 1. âœ… **ä½¿ç”¨å†…ç½® TURN æœåŠ¡å™¨**ï¼ˆæ¨èï¼Œå·²é›†æˆï¼‰
  >    - åœ¨ `config.json` ä¸­è®¾ç½® `"turnConfig.enabled": true`
  >    - ç¡®ä¿é˜²ç«å¢™å¼€æ”¾ç›¸åº”ç«¯å£
  > 2. **ç¦ç”¨ TURN æœåŠ¡å™¨**ï¼ˆä»…å±€åŸŸç½‘ä½¿ç”¨ï¼‰
  >    - åœ¨ `config.json` ä¸­è®¾ç½® `"turnConfig.enabled": false`
  >    - é€‚ç”¨äºåŒç½‘æ®µå†…çš„ç®€å•é€šä¿¡

### nginx ä»£ç†é…ç½®æ ·ä¾‹

```
server
{
  server_name fagedongxi.com;
  index index.html;
  listen 80;

  location / {
    proxy_pass  http://127.0.0.1:8081/;
  }

  location /ws/ {
      proxy_pass http://127.0.0.1:8081/ws/;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

}
```

## å…è´£å£°æ˜ï¼š

æœ¬é¡¹ç›®ä»…ç”¨äºå­¦ä¹ äº¤æµï¼Œè¯·å‹¿ç”¨äºéæ³•ç”¨é€”ï¼Œå¦åˆ™åæœè‡ªè´Ÿã€‚
